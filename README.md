# OTUS_4 Загрузка системы (Centos 7)
-----------------------------------------------------------------------
### Домашнее задание

    Работа с загрузчиком
    1. Попасть в систему без пароля несколькими способами
    2. Установить систему с LVM, после чего переименовать VG
    3. Добавить модуль в initrd

1. Попасть в систему без пароля.
Первый вариант:
- Заходим в загрузчик до старта системы (в момент выбора вариаций загрузки нажать на клашиву e)
- В строке начинающейся с "linux16" меняем ro на rw, убираем из нее все значение "console=tty0 console=ttyS0,115200" и добавляем  в конец "rd.break enforcing=0", для применения измененной конфигации нажимаем Ctrl+X
- Система запускается в однопользовательском режиме и мы вводим :
      chroot /sysroot # change process directory
      passwd root   # change password
      exit
      reboot
- По инструкции так же необходимо создать скрытый файл .autorelabel, но у меня он не сработал. Зайти под новым паролем не получается.
- Перезагружаемся, заходим в загрузчик, в строке начинающейся с "linux16" в конце добавляем "enforcing=0" (переводим SELinux в режим не припятствования).Нажимаем Ctrl+X
- Перезагружаемся, теперь мы можем зайти под root, новый пароль
- Если надо опять включить SELinux, производим в ручную перемаркировать файлы "fixfiles -f relabel", и переводим в режим Enforcing "setenforce 1".
- Далее можем перезагружаться и попробовать войти в систему, это получилось сделать.

Второй вариант:
- Заходим в загрузчик до старта системы (в момент выбора вариаций загрузки нажать на клашиву e)
- В строке начинающейся с "linux16" меняем ro на rw, убираем из нее все значение "console=tty0 console=ttyS0,115200" и добавляем  в конец "init=/bin/sh", для применения измененной конфигации нажимаем Ctrl+X
- Система перезапускается и мы вводим :
      passwd root   # change password
- Меняем в "/etc/selinux/config" значение "SELINUX=Enforcing" на "Permissive" и перезагружаемся.
- Заходим под новым паролем и выполняем "fixfilex -f relabel"

2. Установить систему с LVM, после чего переименовать VG:
- Смотрим какие Volume Group у нас есть: "vgs"
- меняем название группе "vgrename VolGroup00 vg_root. 
- Проверить что переименование произведено "ls -l /dev/mapper"
- Правим файл "/etc/fstab", заменяем все VolGroup00 на vg_root
- Правим файл "/etc/default/grub" и ищем строку начинающуюся с "GRUB_CMDLINE_LINUX" и заменяем VolGroup00 на vg_root
- Правим файл "/boot/grub2/grub.cfg", в строке начинающейся с "linux16" меняем все VolGroup00 на vg_root
- Пересоздаем initrd image,что бы поменялся путь монтирования: "mkinitrd -f -v /boot/initramfs-$(uname -r).img $(uname -r)".
- Перезагружаем компьютер, и проверяем командой "vgs".

3. Добавить модуль в initrd:
- Скрипты модулей хранятся в каталоге /usr/lib/dracut/modules.d/. Создаем новую папку: "mkdir /usr/lib/dracut/modules.d/01test"
- Создаем серипты: "touch module-setup.sh" и "touch test.sh", делаем их исполняемыми chmod +x module-setup.sh и chmod +x test.sh.
- В скрипт "module-setup.sh" вписываем:

#!/bin/bash

check() { # модуль должен быть включен по умолчанию
    return 0
}

depends() { # Выводит все зависимости от которых зависит наш модуль
    return 0
}

install() {
    inst_hook cleanup 00 "${moddir}/test.sh" # Запускает скрипт
}

- В скрипт "test.sh" вписываем::

#!/bin/bash

cat <<'msgend'
Hello! You are in dracut module!
 ___________________
< I'm dracut module >
 -------------------
   \
    \
        .--.
       |o_o |
       |:_/ |
      //   \ \
     (|     | )
    /'\_   _/`\
    \___)=(___/
msgend
sleep 10
echo " continuing...."

- выполняем команду "dracut -f -v" и перезагружаемся
